---
import BaseLayout from '@/layouts/BaseLayout.astro'
import RichText from '@/components/RichText.astro'
import Button from '@/components/ui/Button.astro'
import Card from '@/components/ui/Card.astro'
import { sanity } from '@/lib/sanity'
import { allProjectSlugsQuery, projectBySlugQuery } from '@/lib/sanityQueries'
import { urlForImage } from '@/lib/sanityImage'

export async function getStaticPaths() {
  if (!sanity) return []
  const projects = await sanity.fetch<{ slug: string }[]>(allProjectSlugsQuery)
  return projects.map((p) => ({ params: { slug: p.slug } }))
}

const { slug } = Astro.params
const project = sanity ? await sanity.fetch<any>(projectBySlugQuery, { slug }) : null

const heroUrl =
  project?.hero?.image &&
  urlForImage(project.hero.image)?.width(2000).fit('max').auto('format').url()
---

<BaseLayout title={project?.title || slug}>
  {
    project ? (
      <>
        <header class="space-y-3">
          <div>
            <Button href="/work" variant="link">
              Back to work
            </Button>
          </div>
          <h1 class="text-4xl tracking-tight">{project.title}</h1>
          {project.year ? <p class="text-muted">{project.year}</p> : null}
        </header>

        {heroUrl ? (
          <Card tone="background" class="mt-10 overflow-hidden p-0">
            <img
              src={heroUrl}
              alt={project.hero?.alt || ''}
              loading="lazy"
              class="aspect-video w-full object-cover"
            />
          </Card>
        ) : null}

        {project.body ? (
          <Card tone="surface" class="mt-6">
            <RichText value={project.body} />
          </Card>
        ) : null}
      </>
    ) : (
      <>
        <h1>Missing content</h1>
        <p>
          Configure Sanity env vars and publish a project with slug: <code>{slug}</code>.
        </p>
      </>
    )
  }
</BaseLayout>
