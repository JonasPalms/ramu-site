---
import BaseLayout from '@/layouts/BaseLayout.astro'
import RichText from '@/components/RichText.astro'
import Card from '@/components/ui/Card.astro'
import Container from '@/components/layout/Container.astro'
import { sanity } from '@/lib/sanity'
import { allProjectSlugsQuery, projectBySlugQuery } from '@/lib/sanityQueries'
import { urlForImage } from '@/lib/sanityImage'

export async function getStaticPaths() {
  if (!sanity) return []
  const projects = await sanity.fetch<{ slug: string }[]>(allProjectSlugsQuery)
  return projects.map((p) => ({ params: { slug: p.slug } }))
}

const { slug } = Astro.params
const project = sanity ? await sanity.fetch<any>(projectBySlugQuery, { slug }) : null

const heroUrl =
  project?.hero?.image &&
  urlForImage(project.hero.image)?.width(2000).fit('max').auto('format').url()
---

<BaseLayout title={project?.title || slug}>
  <Container size="wide" class="space-y-8">
    <header class="space-y-3">
      <div>
        <a href="/projects">Back to projects</a>
      </div>
      <h1 class="text-4xl tracking-tight">{project.title}</h1>
      {project.year ? <p class="text-muted">{project.year}</p> : null}
    </header>
    {
      heroUrl ? (
        <section class="pt-6">
          <img
            src={heroUrl}
            alt={project.hero?.alt || ''}
            loading="lazy"
            class="aspect-video w-full object-cover"
          />
        </section>
      ) : null
    }
    {
      project.body ? (
        <section>
          <Card tone="surface">
            <RichText value={project.body} />
          </Card>
        </section>
      ) : null
    }
  </Container>
</BaseLayout>
