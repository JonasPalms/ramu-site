---
import BaseLayout from '@/layouts/BaseLayout.astro'
import RichText from '@/components/RichText.astro'
import Button from '@/components/ui/Button.astro'
import Card from '@/components/ui/Card.astro'
import Container from '@/components/layout/Container.astro'
import { sanity } from '@/lib/sanity'
import { projectsIndexQuery, projectsPageQuery } from '@/lib/sanityQueries'
import { urlForImage } from '@/lib/sanityImage'

const projectsPage = sanity ? await sanity.fetch<any>(projectsPageQuery) : null
const projects = sanity ? await sanity.fetch<any[]>(projectsIndexQuery) : []
---

<BaseLayout title={projectsPage?.seo?.metaTitle || projectsPage?.title}>
  <Container size="wide" class="space-y-8">
    <header class="space-y-3">
      {projectsPage?.title ? <h1 class="text-4xl tracking-tight">{projectsPage.title}</h1> : null}
      {
        projectsPage?.intro ? (
          <section class="max-w-3xl">
            <RichText value={projectsPage.intro} />
          </section>
        ) : null
      }
    </header>

    <div class="grid gap-4">
      {
        projects.length ? (
          <>
            {projects.map((p) => (
              <Card
                as="article"
                tone="surface"
                class="group flex items-start justify-between gap-4"
              >
                <div class="min-w-0 flex-1">
                  <h2 class="text-xl tracking-tight">{p.title}</h2>
                  <p class="mt-2 text-sm text-muted">{p.year ? p.year : 'â€”'}</p>
                </div>
                <div class="h-16 w-24 shrink-0 overflow-hidden rounded-md border border-border bg-background">
                  {p.hero?.image ? (
                    <img
                      src={urlForImage(p.hero.image)
                        ?.width(360)
                        .height(240)
                        .fit('crop')
                        .auto('format')
                        .url()}
                      alt={p.hero?.alt || p.title || ''}
                      loading="lazy"
                      class="h-full w-full object-cover transition-transform duration-300 ease-out group-hover:scale-105 motion-reduce:transition-none motion-reduce:group-hover:scale-100"
                    />
                  ) : (
                    <div class="h-full w-full" aria-hidden="true" />
                  )}
                </div>
                <div class="shrink-0">
                  <Button href={`/projects/${p.slug}`} variant="outline" size="sm">
                    View
                  </Button>
                </div>
              </Card>
            ))}
          </>
        ) : null
      }
    </div>
  </Container>
</BaseLayout>
