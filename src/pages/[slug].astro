---
import BaseLayout from '../layouts/BaseLayout.astro'
import RichText from '../components/RichText.astro'
import { sanity } from '../lib/sanity'
import { allPageSlugsQuery, pageBySlugQuery } from '../lib/sanityQueries'

export async function getStaticPaths() {
  if (!sanity) return []
  const pages = await sanity.fetch<{ slug: string }[]>(allPageSlugsQuery)
  return pages.filter((p) => p.slug && p.slug !== 'home').map((p) => ({ params: { slug: p.slug } }))
}

const { slug } = Astro.params
const page = sanity ? await sanity.fetch<any>(pageBySlugQuery, { slug }) : null
---

<BaseLayout title={page?.title || slug}>
  {
    page ? (
      <>
        <h1>{page.title}</h1>
        <RichText value={page.content} />
      </>
    ) : (
      <>
        <h1>Missing content</h1>
        <p>
          Configure Sanity env vars and publish a page with slug: <code>{slug}</code>.
        </p>
      </>
    )
  }
</BaseLayout>
